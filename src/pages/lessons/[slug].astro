---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

// 1. Generar rutas
export async function getStaticPaths() {
  const lessons = await getCollection('lessons');
  return lessons.map(entry => ({
    params: { slug: entry.slug }, 
    props: { entry },
  }));
}

// 2. Obtener contenido y encabezados para la Tabla de Contenidos (TOC)
const { entry } = Astro.props;
const { Content, headings } = await entry.render();
---

<Layout title={`${entry.data.title} - Curso Espa√±ol`}>
  <main class="min-h-screen bg-slate-50 py-12">
    <div class="max-w-6xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-[1fr_250px] gap-8">
      
      {/* COLUMNA PRINCIPAL: LA LECCI√ìN */}
      <article class="bg-white shadow-xl rounded-lg overflow-hidden h-fit">
        
        <header class="relative bg-brand-dark text-white p-8 border-b-8 border-brand-green">
          <div class="relative z-10">
            <span class="inline-block bg-brand-yellow text-brand-dark text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider mb-3">
              {entry.data.unit}
            </span>
            <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight mb-2">
              {entry.data.title}
            </h1>
          </div>
          <div class="absolute top-0 right-0 w-32 h-32 bg-brand-blue opacity-10 rounded-bl-full"></div>
        </header>

        <div class="px-8 py-10 md:px-12">
          {/* Aqu√≠ inyectamos el contenido Markdown con estilos */}
          <div class="prose prose-lg max-w-none 
            prose-headings:text-brand-green 
            prose-h3:text-brand-blue 
            prose-a:text-brand-red prose-a:no-underline hover:prose-a:underline
            prose-strong:text-brand-brown
            prose-li:marker:text-brand-yellow
            interactive-zone"> {/* Clase clave para el script JS */}
            
            <Content />
            
          </div>

          <div class="mt-12 pt-8 border-t border-gray-100">
            <a href={import.meta.env.BASE_URL} class="inline-flex items-center text-brand-blue font-semibold hover:text-brand-dark transition-colors">
              ‚Üê Volver al √≠ndice del curso
            </a>
          </div>
        </div>
      </article>

      {/* COLUMNA LATERAL: TABLA DE CONTENIDOS FLOTANTE */}
      <aside class="hidden lg:block">
        <div class="sticky top-8 p-4 bg-white rounded-lg shadow-sm border border-slate-200">
          <h3 class="font-bold text-brand-dark mb-4 uppercase text-xs tracking-wider">En esta lecci√≥n</h3>
          <ul class="space-y-2 text-sm">
            {headings.map((heading) => (
              <li class={`pl-${(heading.depth - 1) * 3}`}>
                <a href={`#${heading.slug}`} class="text-slate-600 hover:text-brand-green transition-colors block py-1 border-l-2 border-transparent hover:border-brand-green pl-2">
                  {heading.text}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </aside>

    </div>
  </main>
</Layout>

<script>
  // --- SCRIPT DE EJERCICIOS INTERACTIVOS ---
  // Convierte autom√°ticamente los <details> en ejercicios rellenables
  document.addEventListener('astro:page-load', () => {
    initExercises();
  });
  
  // Ejecutar tambi√©n si no hay ViewTransitions
  initExercises();

  function initExercises() {
    const detailsElements = document.querySelectorAll('.interactive-zone details');

    detailsElements.forEach((details, index) => {
      // 1. Extraer la respuesta correcta del interior del <details>
      // Asumimos que la IA pone la respuesta dentro, limpia de etiquetas si es posible
      const summary = details.querySelector('summary');
      const correctAnswerText = details.innerText.replace(summary ? summary.innerText : '', '').trim();
      
      // 2. Crear la interfaz del ejercicio
      const container = document.createElement('div');
      container.className = "my-6 p-4 bg-slate-50 rounded-lg border border-slate-200";
      
      const inputId = `ex-${index}`;
      container.innerHTML = `
        <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
          <input type="text" id="${inputId}" placeholder="Escribe tu respuesta..." 
            class="flex-1 px-4 py-2 border border-slate-300 rounded focus:ring-2 focus:ring-brand-blue focus:border-brand-blue outline-none w-full sm:w-auto" />
          <button id="btn-${index}" class="px-4 py-2 bg-brand-green text-white font-bold rounded hover:bg-opacity-90 transition-colors shadow-sm">
            Comprobar
          </button>
        </div>
        <div id="feedback-${index}" class="mt-3 hidden text-sm font-bold"></div>
      `;

      // 3. Reemplazar el <details> original (o esconderlo)
      details.parentNode?.insertBefore(container, details);
      // Guardamos el details original oculto por si quieren "rendirse" y ver la soluci√≥n
      details.style.display = 'none'; 
      
      // Bot√≥n de ayuda para mostrar la soluci√≥n original
      const helpBtn = document.createElement('button');
      helpBtn.innerText = "Me rindo (Ver soluci√≥n)";
      helpBtn.className = "text-xs text-slate-400 mt-2 hover:text-brand-red underline";
      helpBtn.onclick = () => { details.style.display = 'block'; helpBtn.style.display = 'none'; };
      container.appendChild(helpBtn);

      // 4. L√≥gica de correcci√≥n
      const btn = container.querySelector(`#btn-${index}`);
      const input = container.querySelector(`#${inputId}`) as HTMLInputElement;
      const feedback = container.querySelector(`#feedback-${index}`);

      btn?.addEventListener('click', () => {
        if(!input || !feedback) return;
        
        const userAnswer = input.value.trim().toLowerCase();
        // Limpiamos la respuesta correcta de puntuaci√≥n b√°sica para comparar
        const cleanCorrect = correctAnswerText.toLowerCase().replace(/[.,!¬°?¬ø]/g, "").trim();
        const cleanUser = userAnswer.replace(/[.,!¬°?¬ø]/g, "").trim();

        feedback.classList.remove('hidden');
        
        if (cleanUser === cleanCorrect || cleanUser.includes(cleanCorrect)) {
          feedback.textContent = "¬°Correcto! üéâ";
          feedback.className = "mt-3 text-sm font-bold text-green-600";
          input.classList.add("border-green-500", "bg-green-50");
        } else {
          feedback.textContent = "Casi... Int√©ntalo de nuevo.";
          feedback.className = "mt-3 text-sm font-bold text-brand-red";
          input.classList.add("border-red-300", "bg-red-50");
        }
      });
    });
  }
</script>
