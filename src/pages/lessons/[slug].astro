<script>
  document.addEventListener('astro:page-load', () => {
    renderAdvancedExercises();
  });
  
  renderAdvancedExercises();

  function renderAdvancedExercises() {
    const dataBlocks = document.querySelectorAll('.exercise-data');
    
    dataBlocks.forEach((block, index) => {
      try {
        const data = JSON.parse(block.textContent);
        const container = document.createElement('div');
        container.id = `app-ex-${index}`;
        container.className = "my-10 p-6 bg-white rounded-xl shadow-lg border-t-4 border-brand-blue ring-1 ring-slate-900/5";
        
        mountExercise(container, data, 'set_a');
        block.parentNode.insertBefore(container, block);
      } catch (e) {
        console.error("Error parsing exercise data", e);
      }
    });
  }

  function mountExercise(container, data, activeSetKey) {
    const items = data[activeSetKey];
    const isSetA = activeSetKey === 'set_a';
    
    let html = `
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 border-b border-slate-100 pb-4">
        <div>
          <h3 class="text-xl font-bold text-brand-dark flex items-center gap-2">
            <span class="material-symbols-outlined text-brand-blue text-3xl">
              ${getIconForType(data.type)}
            </span>
            ${data.title}
          </h3>
          <p class="text-slate-500 text-sm mt-1 ml-1 leading-relaxed max-w-2xl">${data.instruction}</p>
        </div>
        <button onclick="switchSet('${container.id}', '${isSetA ? 'set_b' : 'set_a'}')" 
          class="text-xs font-bold px-4 py-2 bg-brand-yellow/10 text-brand-brown rounded-full hover:bg-brand-yellow/30 transition flex items-center gap-2 border border-brand-yellow/20 whitespace-nowrap">
          ${isSetA ? '<span class="material-symbols-outlined text-sm">refresh</span> Ejercicios Nuevos' : '<span class="material-symbols-outlined text-sm">undo</span> Volver al Original'}
        </button>
      </div>
    `;

    // Renderizar seg√∫n tipo (AHORA CON M√ÅS VARIEDAD)
    if (data.type === 'fill_gaps') {
      html += renderFillGaps(items, container.id);
    } else if (data.type === 'matching') {
      html += renderMatching(items, container.id);
    } else if (data.type === 'flashcards') {
      html += renderFlashcards(items, container.id);
    } else if (data.type === 'multiple_choice') { // <--- NUEVO TIPO
      html += renderMultipleChoice(items, container.id);
    } else {
      html += renderFillGaps(items, container.id); // Fallback
    }

    container.innerHTML = html;
    container.dataset.jsonData = JSON.stringify(data);
  }

  function getIconForType(type) {
      const map = {
          'fill_gaps': 'edit_note',
          'matching': 'join_inner',
          'flashcards': 'style',
          'multiple_choice': 'quiz'
      };
      return map[type] || 'fitness_center';
  }

  // --- TIPO 1: Rellena los huecos ---
  function renderFillGaps(items, id) {
    let html = `<div class="space-y-4">`;
    items.forEach((item, i) => {
      const parts = item.q.split(/___|\(\.\.\.\)/);
      const inputHtml = `<input type="text" data-ans="${item.a}" class="mx-2 px-3 py-1 border-b-2 border-slate-300 focus:border-brand-blue outline-none bg-slate-50 text-center font-bold text-brand-blue min-w-[100px] transition-colors" placeholder="?">`;
      const content = parts.length > 1 ? parts.join(inputHtml) : `${item.q} ${inputHtml}`;

      html += `
        <div class="p-4 bg-slate-50 rounded-lg flex flex-col sm:flex-row items-start sm:items-center gap-3 exercise-row transition-colors duration-300">
          ${item.icon ? `<span class="material-symbols-outlined text-slate-400 select-none">${item.icon}</span>` : ''}
          <div class="leading-loose text-lg text-slate-700 flex-1 flex flex-wrap items-center">
            ${content}
          </div>
          <span class="feedback-icon material-symbols-outlined opacity-0 text-2xl select-none">check_circle</span>
        </div>
      `;
    });
    html += getCheckButtonHtml(id, 'checkFillGaps');
    return html;
  }

  // --- TIPO 2: Relacionar Columnas ---
  function renderMatching(items, id) {
    const answers = [...items].map((item, originalIdx) => ({...item, originalIdx})).sort(() => Math.random() - 0.5);
    
    let html = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 matching-game select-none" id="${id}-match">`;
    
    html += `<div class="space-y-3">`;
    items.forEach((item, i) => {
      html += `
        <button onclick="selectMatch('${id}', 'q', ${i})" class="match-card q-card w-full text-left p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-brand-blue hover:bg-blue-50/50 transition relative group" data-idx="${i}">
          <div class="flex items-center gap-3">
            <span class="h-6 w-6 rounded-full bg-slate-100 text-xs font-bold flex items-center justify-center text-slate-500 group-hover:bg-brand-blue group-hover:text-white transition-colors">${i + 1}</span>
            <span class="font-bold text-brand-dark">${item.q}</span>
          </div>
        </button>
      `;
    });
    html += `</div>`;

    html += `<div class="space-y-3">`;
    answers.forEach((item, i) => {
      html += `
        <button onclick="selectMatch('${id}', 'a', ${item.originalIdx})" class="match-card a-card w-full text-left p-4 bg-slate-50 border-2 border-slate-200 rounded-xl hover:border-brand-green hover:bg-green-50/50 transition relative flex items-center gap-3" data-idx="${item.originalIdx}">
          ${item.icon ? `<span class="material-symbols-outlined text-2xl text-brand-primary">${item.icon}</span>` : ''}
          <span class="text-slate-600 font-medium">${item.a}</span>
        </button>
      `;
    });
    html += `</div></div>`;
    return html;
  }

  // --- TIPO 3: Flashcards ---
  function renderFlashcards(items, id) {
    let html = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">`;
    items.forEach((item) => {
      html += `
        <div class="group h-40 perspective-1000 cursor-pointer" onclick="this.classList.toggle('flipped')">
          <div class="relative h-full w-full transition-all duration-500 transform-style-3d group-hover:shadow-xl rounded-xl shadow-md">
            <div class="absolute inset-0 bg-white border-2 border-slate-100 rounded-xl flex flex-col items-center justify-center backface-hidden p-4">
              ${item.icon ? `<span class="material-symbols-outlined text-4xl text-brand-blue mb-2">${item.icon}</span>` : ''}
              <span class="font-bold text-lg text-brand-dark">${item.q}</span>
              <span class="text-xs text-slate-400 mt-2">Gira para ver</span>
            </div>
            <div class="absolute inset-0 bg-brand-primary text-white rounded-xl flex items-center justify-center backface-hidden rotate-y-180 p-4 text-center">
              <span class="font-bold text-xl">${item.a}</span>
            </div>
          </div>
        </div>
      `;
    });
    html += `</div>
    <style>.perspective-1000 { perspective: 1000px; } .transform-style-3d { transform-style: preserve-3d; } .backface-hidden { backface-visibility: hidden; } .rotate-y-180 { transform: rotateY(180deg); } .flipped .transform-style-3d { transform: rotateY(180deg); } </style>`;
    return html;
  }

  // --- TIPO 4: Multiple Choice (NUEVO) ---
  function renderMultipleChoice(items, id) {
    let html = `<div class="space-y-6">`;
    items.forEach((item, i) => {
      // item.options debe ser un array ["a", "b", "c"]. La IA lo generar√°.
      // item.a es la respuesta correcta.
      const options = item.options || [];
      const optionsHtml = options.map((opt, idx) => `
        <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition quiz-option">
          <input type="radio" name="quiz-${id}-${i}" value="${opt}" class="w-4 h-4 text-brand-green focus:ring-brand-green">
          <span class="text-slate-700">${opt}</span>
        </label>
      `).join('');

      html += `
        <div class="quiz-item" data-correct="${item.a}">
          <div class="font-bold text-brand-dark mb-3 flex gap-2">
            <span class="bg-brand-blue/10 text-brand-blue w-6 h-6 rounded-full flex items-center justify-center text-xs shrink-0">${i+1}</span>
            <p>${item.q}</p>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 pl-8">
            ${optionsHtml}
          </div>
          <div class="feedback-msg hidden mt-2 pl-8 text-sm font-bold"></div>
        </div>
      `;
    });
    html += getCheckButtonHtml(id, 'checkMultipleChoice');
    return html;
  }

  function getCheckButtonHtml(id, functionName) {
      return `
      <div class="mt-8 text-center pt-4 border-t border-slate-100">
        <button onclick="${functionName}('${id}')" class="px-8 py-3 bg-brand-green text-white font-bold rounded-lg shadow-md hover:bg-opacity-90 hover:translate-y-[-1px] transition-all flex items-center gap-2 mx-auto">
          <span class="material-symbols-outlined">check_circle</span> Corregir Ejercicios
        </button>
      </div></div>`;
  }

  // ==========================================
  // LOGICA GLOBAL
  // ==========================================

  window.switchSet = (containerId, setKey) => {
    const container = document.getElementById(containerId);
    if (!container.dataset.jsonData) return;
    mountExercise(container, JSON.parse(container.dataset.jsonData), setKey);
  };

  window.checkFillGaps = (containerId) => {
    const container = document.getElementById(containerId);
    const inputs = container.querySelectorAll('input');
    inputs.forEach(input => {
      const userVal = input.value.trim().toLowerCase().replace(/[.,!¬°?¬ø]/g, "");
      const correctVal = input.dataset.ans.toLowerCase().replace(/[.,!¬°?¬ø]/g, "");
      const row = input.closest('.exercise-row');
      const icon = row.querySelector('.feedback-icon');
      
      if(userVal && (userVal === correctVal || userVal.includes(correctVal))) {
        input.classList.add('text-green-700', 'border-green-500', 'bg-green-50');
        input.classList.remove('text-red-700', 'border-red-300');
        icon.innerText = 'check_circle'; icon.className = 'feedback-icon material-symbols-outlined text-green-500 opacity-100 ml-auto transition';
      } else {
        input.classList.add('text-red-700', 'border-red-300', 'bg-red-50');
        icon.innerText = 'cancel'; icon.className = 'feedback-icon material-symbols-outlined text-red-400 opacity-100 ml-auto transition';
      }
    });
  };

  window.checkMultipleChoice = (containerId) => {
    const container = document.getElementById(containerId);
    const items = container.querySelectorAll('.quiz-item');
    
    items.forEach(item => {
      const correct = item.dataset.correct;
      const selected = item.querySelector('input:checked')?.value;
      const feedback = item.querySelector('.feedback-msg');
      const options = item.querySelectorAll('.quiz-option');
      
      // Reset styles
      options.forEach(opt => opt.classList.remove('bg-green-100', 'border-green-500', 'bg-red-100', 'border-red-500', 'opacity-50'));
      feedback.classList.add('hidden');

      if (!selected) return;

      if (selected === correct) {
        feedback.textContent = "¬°Correcto! üéâ";
        feedback.className = "feedback-msg mt-2 pl-8 text-sm font-bold text-green-600 block";
        item.querySelector('input:checked').closest('label').classList.add('bg-green-100', 'border-green-500');
      } else {
        feedback.textContent = "Incorrecto. Int√©ntalo de nuevo.";
        feedback.className = "feedback-msg mt-2 pl-8 text-sm font-bold text-red-500 block";
        item.querySelector('input:checked').closest('label').classList.add('bg-red-100', 'border-red-500');
      }
    });
  };

  // Matching Logic (Simplificada)
  let selectedQ = null;
  window.selectMatch = (containerId, type, idx) => {
    const container = document.getElementById(containerId);
    if (type === 'q') {
      container.querySelectorAll('.q-card').forEach(el => {
          if (!el.classList.contains('opacity-50')) el.classList.remove('border-brand-blue', 'bg-blue-50', 'ring-2', 'ring-brand-blue');
      });
      const card = container.querySelector(`.q-card[data-idx="${idx}"]`);
      if (!card.classList.contains('opacity-50')) {
          card.classList.add('border-brand-blue', 'bg-blue-50', 'ring-2', 'ring-brand-blue');
          selectedQ = idx;
      }
    } 
    if (type === 'a') {
      if (selectedQ === null) return; 
      const cardA = container.querySelector(`.a-card[data-idx="${idx}"]`);
      const cardQ = container.querySelector(`.q-card[data-idx="${selectedQ}"]`);
      if (cardA.classList.contains('opacity-50')) return;

      if (parseInt(selectedQ) === parseInt(idx)) {
        [cardQ, cardA].forEach(card => {
            card.classList.remove('border-brand-blue', 'bg-blue-50', 'ring-2', 'ring-brand-blue', 'border-slate-200');
            card.classList.add('border-green-500', 'bg-green-50', 'text-green-700', 'opacity-50', 'cursor-default');
            const icon = document.createElement('span');
            icon.className = "material-symbols-outlined absolute top-2 right-2 text-green-600 text-lg";
            icon.innerText = "check";
            card.appendChild(icon);
        });
        selectedQ = null;
      } else {
        cardA.classList.add('animate-shake', 'border-red-400', 'bg-red-50');
        setTimeout(() => cardA.classList.remove('animate-shake', 'border-red-400', 'bg-red-50'), 500);
        selectedQ = null;
        container.querySelectorAll('.q-card').forEach(el => el.classList.remove('border-brand-blue', 'bg-blue-50', 'ring-2', 'ring-brand-blue'));
      }
    }
  };
</script>
