---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

// 1. Generar rutas
export async function getStaticPaths() {
  const lessons = await getCollection('lessons');
  return lessons.map(entry => ({
    params: { slug: entry.slug }, 
    props: { entry },
  }));
}

// 2. Obtener contenido y encabezados
const { entry } = Astro.props;
const { Content, headings } = await entry.render();

// Encontrar si hay secci√≥n de pr√°ctica para el bot√≥n directo
const practiceHeading = headings.find(h => h.text.includes("Pr√°ctica") || h.text.includes("Exercises"));
---

<Layout title={`${entry.data.title} - Curso Espa√±ol`}>
  <main class="min-h-screen bg-slate-50 py-8">
    {/* Layout Grid: Sidebar Izquierda (260px) - Contenido Derecha (Resto) */}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 lg:grid-cols-[260px_1fr] gap-8 items-start">
      
      {/* --- COLUMNA IZQUIERDA: NAVEGACI√ìN (Sticky) --- */}
      <aside class="hidden lg:block sticky top-6 h-[calc(100vh-3rem)] overflow-y-auto pr-2 custom-scrollbar">
        <nav class="space-y-6">
          <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
            <h3 class="font-bold text-brand-dark mb-3 uppercase text-xs tracking-wider border-b border-slate-100 pb-2">
              Navegaci√≥n
            </h3>
            <ul class="space-y-1 text-sm">
              {headings.map((heading) => (
                <li class={`
                  ${heading.depth === 2 ? 'font-semibold mt-3' : 'text-slate-500 pl-3'}
                  ${heading.text.includes('Pr√°ctica') ? 'text-brand-green font-bold' : ''}
                `}>
                  <a href={`#${heading.slug}`} 
                     class="block py-1 hover:text-brand-blue transition-colors leading-tight">
                    {heading.text}
                  </a>
                </li>
              ))}
            </ul>
          </div>

          <div class="bg-brand-accent/10 rounded-lg p-4 border border-brand-accent/20">
            <a href={import.meta.env.BASE_URL} class="flex items-center gap-2 text-sm font-semibold text-brand-dark hover:text-brand-blue transition-colors">
              <span>‚Üê</span> Volver al curso
            </a>
          </div>
        </nav>
      </aside>

      {/* --- COLUMNA DERECHA: CONTENIDO --- */}
      <article class="bg-white shadow-sm rounded-lg overflow-hidden border border-slate-200">
        
        {/* Cabecera Compacta */}
        <header class="relative bg-brand-dark text-white p-6 md:p-10 border-b-4 border-brand-green overflow-hidden">
          <div class="relative z-10">
            <div class="flex flex-wrap items-center gap-3 mb-2">
              <span class="inline-block bg-brand-green text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider">
                {entry.data.unit}
              </span>
              {practiceHeading && (
                <a href={`#${practiceHeading.slug}`} 
                   class="inline-flex items-center gap-1 bg-white/20 hover:bg-white/30 text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider transition-colors cursor-pointer">
                   ‚ö° Ir a Ejercicios
                </a>
              )}
            </div>
            <h1 class="text-2xl md:text-4xl font-extrabold tracking-tight leading-tight">
              {entry.data.title}
            </h1>
          </div>
          {/* Decoraci√≥n sutil */}
          <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
        </header>

        {/* √çNDICE SUPERIOR (Resumen Visual) */}
        <div class="bg-slate-50 border-b border-slate-100 p-6">
          <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">En esta lecci√≥n:</p>
          <ul class="columns-1 sm:columns-2 gap-x-8 space-y-2 text-sm">
            {headings.filter(h => h.depth <= 2).map((heading) => (
              <li class="break-inside-avoid">
                <a href={`#${heading.slug}`} class="flex items-start gap-2 text-slate-700 hover:text-brand-blue group">
                  <span class="text-brand-green/50 group-hover:text-brand-green">‚Ä¢</span>
                  <span class="border-b border-transparent group-hover:border-brand-blue/30 leading-snug">
                    {heading.text}
                  </span>
                </a>
              </li>
            ))}
          </ul>
        </div>

        {/* CONTENIDO PRINCIPAL */}
        <div class="px-6 py-8 md:px-10">
          {/* CAMBIOS TIPOGR√ÅFICOS: 
              - 'prose' en vez de 'prose-lg' (texto m√°s peque√±o)
              - 'prose-p:leading-relaxed' (menos separaci√≥n vertical excesiva)
              - 'max-w-none' (aprovecha el ancho) 
          */}
          <div class="prose prose-slate max-w-none 
            prose-p:text-base prose-p:leading-7 prose-p:text-slate-700
            prose-headings:text-brand-dark prose-headings:font-bold prose-headings:tracking-tight
            prose-h2:text-2xl prose-h2:mt-10 prose-h2:pb-2 prose-h2:border-b prose-h2:border-slate-100
            prose-h3:text-lg prose-h3:text-brand-blue prose-h3:mt-6
            prose-a:text-brand-red prose-a:no-underline hover:prose-a:underline
            prose-strong:text-brand-brown prose-strong:font-bold
            prose-li:marker:text-brand-yellow
            prose-table:text-sm
            interactive-zone"> 
            
            <Content />
            
          </div>

          <div class="mt-12 pt-8 border-t border-slate-100 text-center">
            <a href={import.meta.env.BASE_URL} class="inline-flex items-center gap-2 text-brand-dark font-medium hover:text-brand-blue transition-colors bg-slate-50 px-4 py-2 rounded-full border border-slate-200 hover:border-brand-blue/30">
              <span>‚Üê</span> Volver al √≠ndice del curso
            </a>
          </div>
        </div>
      </article>

    </div>
  </main>
</Layout>

<style>
  /* Scrollbar personalizado para el sidebar */
  .custom-scrollbar::-webkit-scrollbar {
    width: 4px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: #cbd5e1;
    border-radius: 20px;
  }
</style>

<script>
  // --- SCRIPT DE EJERCICIOS INTERACTIVOS (Autocorrecci√≥n) ---
  document.addEventListener('astro:page-load', () => {
    initExercises();
  });
  
  initExercises();

  function initExercises() {
    const detailsElements = document.querySelectorAll('.interactive-zone details');

    detailsElements.forEach((details, index) => {
      const summary = details.querySelector('summary');
      const correctAnswerText = details.innerText.replace(summary ? summary.innerText : '', '').trim();
      
      // Dise√±o mejorado de la caja de ejercicios
      const container = document.createElement('div');
      container.className = "my-6 bg-white rounded-lg border-l-4 border-brand-blue shadow-sm p-5 ring-1 ring-slate-900/5";
      
      const inputId = `ex-${index}`;
      
      // Obtenemos la pregunta (que suele estar en negrita justo antes del details)
      // Esto es un intento de mejorar la UX visual
      let questionText = "Ejercicio Pr√°ctico";
      const prevEl = details.previousElementSibling;
      if (prevEl && (prevEl.tagName === 'STRONG' || prevEl.tagName === 'B' || prevEl.tagName === 'P')) {
         // Opcional: Podr√≠amos mover la pregunta dentro del container para que quede encapsulada
      }

      container.innerHTML = `
        <div class="flex flex-col gap-3">
          <label for="${inputId}" class="text-sm font-semibold text-slate-700 block uppercase tracking-wide text-[10px]">Tu respuesta:</label>
          <div class="flex flex-col sm:flex-row gap-2">
            <input type="text" id="${inputId}" placeholder="Escribe aqu√≠..." 
              class="flex-1 px-3 py-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-brand-blue/20 focus:border-brand-blue outline-none transition-all" />
            <button id="btn-${index}" class="px-4 py-2 bg-brand-blue text-white text-sm font-bold rounded hover:bg-brand-dark transition-colors shadow-sm whitespace-nowrap">
              Comprobar
            </button>
          </div>
          <div id="feedback-${index}" class="hidden text-sm font-medium p-2 rounded bg-slate-50 border border-slate-100 mt-1"></div>
        </div>
      `;

      details.parentNode?.insertBefore(container, details);
      details.style.display = 'none'; 
      
      const helpBtn = document.createElement('button');
      helpBtn.innerText = "Mostrar soluci√≥n";
      helpBtn.className = "text-[11px] text-slate-400 mt-2 hover:text-brand-red font-medium transition-colors";
      helpBtn.onclick = () => { 
        details.style.display = 'block'; 
        details.open = true; 
        helpBtn.style.display = 'none'; 
      };
      container.appendChild(helpBtn);

      const btn = container.querySelector(`#btn-${index}`);
      const input = container.querySelector(`#${inputId}`) as HTMLInputElement;
      const feedback = container.querySelector(`#feedback-${index}`);

      // Permitir Enter para enviar
      input?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') btn?.click();
      });

      btn?.addEventListener('click', () => {
        if(!input || !feedback) return;
        
        const userAnswer = input.value.trim().toLowerCase();
        const cleanCorrect = correctAnswerText.toLowerCase().replace(/[.,!¬°?¬ø]/g, "").trim();
        const cleanUser = userAnswer.replace(/[.,!¬°?¬ø]/g, "").trim();

        feedback.classList.remove('hidden');
        feedback.classList.remove('text-green-700', 'bg-green-50', 'border-green-100', 'text-red-700', 'bg-red-50', 'border-red-100');
        
        if (cleanUser === cleanCorrect || (cleanCorrect.length > 3 && cleanUser.includes(cleanCorrect))) {
          feedback.innerHTML = "¬°Correcto! üéâ <span class='block text-xs font-normal text-slate-500 mt-1'>Sigue as√≠.</span>";
          feedback.classList.add('text-green-700', 'bg-green-50', 'border-green-100');
          input.classList.add("border-green-500", "ring-1", "ring-green-500");
          input.classList.remove("border-red-300", "ring-red-300");
        } else {
          feedback.textContent = "Incorrecto. Int√©ntalo otra vez.";
          feedback.classList.add('text-red-700', 'bg-red-50', 'border-red-100');
          input.classList.add("border-red-300", "ring-1", "ring-red-300");
          input.classList.remove("border-green-500", "ring-green-500");
        }
      });
    });
  }
</script>
